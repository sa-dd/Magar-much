<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Delivery Boy Home</title>
</head>

<body>
    <!-- Your HTML content goes here -->

    <div class="container">
        <h1>Your Orders: </h1>
        <table class="table" id="orders-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Food Items</th>
                    <th>Order Date</th>
                    <th>Delivery Date</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Payment Method</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- The table rows will be generated by JavaScript -->
            </tbody>
        </table>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script src="deliveryboyhome.js"></script>

    <script>
        const deliveryBoy = JSON.parse(localStorage.getItem("deliveryBoy"));
        console.log(deliveryBoy);

        async function fetchOrders() {
            const response = await fetch("http://localhost:8080/api/orders");
            return await response.json();
        }

        async function fetchOrderDetails() {
            const response = await fetch("http://localhost:8080/api/orderdetails");
            return await response.json();
        }

        async function fetchFoodItems() {
            const response = await fetch("http://localhost:8080/api/fooditems");
            return await response.json();
        }

        async function fetchCustomers() {
            const response = await fetch("http://localhost:8080/api/customers");
            return await response.json();
        }

        async function fetchAddresses() {
            const response = await fetch("http://localhost:8080/api/addresses");
            return await response.json();
        }

        (async function loadData() {
            const orders = await fetchOrders();
            const orderDetails = await fetchOrderDetails();
            const foodItems = await fetchFoodItems();
            const customers = await fetchCustomers();
            const addresses = await fetchAddresses();

            const deliveryBoyOrders = orders.filter(order => order.DeliveryBoyID === deliveryBoy.ID);

            // Process the data and display it on the webpage
            displayOrders(deliveryBoyOrders, orderDetails, foodItems, customers);
        })();


        function displayOrders(deliveryBoyOrders, orderDetails, foodItems, customers) {
            const tableBody = document.querySelector("#orders-table tbody");

            deliveryBoyOrders.forEach(order => {
                const customer = customers.find(c => c.ID === order.CustomerID);
                const orderDetail = orderDetails.filter(od => od.OrderID === order.ID);
                const foodItemNames = orderDetail.map(od => {
                    const foodItem = foodItems.find(fi => fi.ID === od.FoodItemID);
                    return `${foodItem.Name} (${od.Quantity})`;
                }).join(', ');

                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${order.ID}</td>
            <td>${customer.Name}</td>
            <td>${foodItemNames}</td>
            <td>${order.OrderDate}</td>
            <td>${order.DeliveryDate}</td>
            <td>${order.TotalAmount}</td>
            <td>${order.Status}</td>
            <td>${order.PaymentMethod}</td>
            <td>
                <button class="btn btn-success" onclick="orderdelivered(${order.ID})">Delivered</button>
            </td>


        `;

                tableBody.appendChild(row);
            });
        }

        //create a div to display name of the delivery boy on the top of the page and logout button
        const div = document.createElement("div");
        div.innerHTML = `
        <div class="container">
            <div class="row">
                <div class="col-6">
                    <h1>Welcome ${deliveryBoy.Name}</h1>
                </div>
                <div class="col-6">
                    <button class="btn btn-danger" id="logout">Logout</button>
                </div>
            </div>
        </div>

        `;

        document.body.prepend(div);

        //logout button
        const logout = document.querySelector("#logout");
        logout.addEventListener("click", function () {
            localStorage.removeItem("deliveryBoy");
            window.location.href = "login.html";
        });



        async function orderdelivered(OrderID)
        {
            const response = await fetch(`http://localhost:8080/api/orderdelivered/${OrderID}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                }

            });

            if (response.status === 201) {
                alert("Order Delivered");
                window.location.reload();
            }
            else {
                alert("Something went wrong");
            }

        }









    </script>
</body>

</html>